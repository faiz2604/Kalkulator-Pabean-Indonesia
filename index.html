<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Pabean & Pajak Impor Indonesia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .section-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            margin-bottom: 1.5rem;
        }
        .input-group {
            margin-bottom: 1rem;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
            text-align: right;
        }
        .input-field:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .input-field:disabled {
            background-color: #F3F4F6;
            cursor: not-allowed;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary {
            background-color: #2563EB;
            color: white;
        }
        .btn-primary:hover {
            background-color: #1D4ED8;
        }
        .btn-secondary {
            background-color: #6B7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4B5563;
        }
        .btn-danger {
            background-color: #EF4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #DC2626;
        }
        .btn-export {
            background-color: #16A34A;
            color: white;
        }
        .btn-export:hover {
            background-color: #15803D;
        }
        .result-display {
            background-color: #F3F4F6;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-size: 1.125rem;
            font-weight: 600;
            color: #1F2937;
        }
        h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 1rem;
        }
        h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 1rem;
            border-bottom: 2px solid #E5E7EB;
            padding-bottom: 0.5rem;
        }
        table {
            width: 100%;
            margin-top: 1rem;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid #E5E7EB;
            vertical-align: middle;
        }
        thead th {
            background-color: #F9FAFB;
            font-weight: 600;
            color: #374151;
        }
        tfoot td {
            font-weight: 700;
            background-color: #F3F4F6;
        }
        .text-right {
            text-align: right;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Kalkulator Kepabeanan Indonesia</h1>
            <p class="text-lg text-gray-600 mt-2">Simulasi Perhitungan PIB, PDRI, dan Sanksi Administrasi</p>
        </header>

        <!-- Main Calculator -->
        <div class="section-card">
            <h2>Kalkulator Cepat PIB (Multi-Item)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 border-b pb-6 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="pib-number">Nomor PIB</label>
                    <input type="text" id="pib-number" class="input-field !text-left" placeholder="000123-20250725-123456">
                </div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1" for="main-insurance">Total Insurance (Rp)</label><input type="text" id="main-insurance" class="input-field number-input" placeholder="150.000"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1" for="main-freight">Total Freight (Rp)</label><input type="text" id="main-freight" class="input-field number-input" placeholder="1.500.000"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1" for="main-royalty">Total Royalty & Lisensi (Rp)</label><input type="text" id="main-royalty" class="input-field number-input" placeholder="0"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1" for="main-warranty">Total Garansi (Rp)</label><input type="text" id="main-warranty" class="input-field number-input" placeholder="0"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1" for="main-discount">Total Diskon (Rp)</label><input type="text" id="main-discount" class="input-field number-input" placeholder="0"></div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="main-pph-tarif">Tarif PPh Ps. 22</label>
                    <select id="main-pph-tarif" class="input-field !text-left">
                        <option value="0.025">2,5% (Dengan API)</option>
                        <option value="0.075">7,5% (Tanpa API)</option>
                        <option value="0.1">10% (Tertentu)</option>
                        <option value="0.005">0,5% (Tertentu)</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table id="pib-table">
                    <thead><tr><th>Serial</th><th>Cost Barang (Rp)</th><th>Tarif BM (%)</th><th>Aksi</th></tr></thead>
                    <tbody id="items-container"></tbody>
                </table>
            </div>
            <button id="add-item-btn" class="btn btn-primary mt-4">Tambah Barang</button>
            <hr class="my-6">
            <div class="flex space-x-4"><button onclick="calculateMain()" class="btn btn-primary text-lg">Hitung & Detailkan PIB</button><button onclick="resetMain()" class="btn btn-secondary">Reset</button></div>
            
            <div id="pib-results-detail" class="mt-4 hidden">
                <h3 class="text-lg font-semibold mb-2">Detail Perhitungan PIB</h3>
                <div class="overflow-x-auto">
                    <table id="pib-results-table">
                        <thead><tr><th>Serial</th><th class="text-right">Nilai Pabean</th><th class="text-right">Bea Masuk</th><th class="text-right">Nilai Impor</th><th class="text-right">PPN</th><th class="text-right">PPh 22</th></tr></thead>
                        <tbody id="pib-results-body"></tbody>
                        <tfoot id="pib-results-foot"></tfoot>
                    </table>
                </div>
                <div class="flex space-x-4 mt-4">
                    <button onclick="exportPIB('xlsx')" class="btn btn-export">Export ke Excel</button>
                    <button onclick="exportPIB('csv')" class="btn btn-export">Export ke CSV (Sheets)</button>
                </div>
            </div>
        </div>

        <!-- Sanctions Calculator -->
        <div class="section-card">
            <h2>Kalkulator Sanksi Administrasi</h2>
            <div id="sanksi-placeholder" class="text-center p-8 bg-gray-100 rounded-lg">
                <p class="text-gray-600 font-medium">Lengkapi dan hitung detail PIB di atas terlebih dahulu untuk mengaktifkan kalkulator sanksi.</p>
            </div>
            <div id="sanksi-content" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="sanksi-jenis-pelanggaran">Jenis Kesalahan</label>
                        <select id="sanksi-jenis-pelanggaran" class="input-field !text-left" onchange="toggleSanksiInput()">
                            <option value="nilai_pabean" selected>Kesalahan Nilai Pabean</option>
                            <option value="tarif">Kesalahan Tarif</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="sanksi-jenis-importir">Jenis Importir</label>
                        <select id="sanksi-jenis-importir" class="input-field !text-left">
                            <option value="umum" selected>Importir Umum</option>
                            <option value="fasilitas">Importir Fasilitas (AEO/MITA/Kawasan Berikat/KITE)*</option>
                        </select>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table id="sanksi-input-table">
                        <thead></thead>
                        <tbody id="sanksi-items-container"></tbody>
                    </table>
                </div>
                <p class="text-xs text-gray-500 mt-2 mb-4">*Skema denda berjenjang akan diterapkan otomatis sesuai aturan.</p>
                <button onclick="calculateSanksi()" class="btn btn-primary">Hitung Sanksi</button>
                <div id="sanksi-result-container" class="mt-4 space-y-2 hidden">
                    <div class="result-display">Total BM Dibayar: <span id="sanksi-total-bm-dibayar"></span></div>
                    <div class="result-display">Total BM Seharusnya: <span id="sanksi-total-bm-seharusnya"></span></div>
                    <div class="result-display">Kekurangan Pembayaran BM: <span id="sanksi-result-kurang"></span></div>
                    <div class="result-display">Persentase Kekurangan: <span id="sanksi-result-persen"></span></div>
                    <div class="result-display">Tarif Denda Berlaku: <span id="sanksi-result-tarif"></span></div>
                    <div class="result-display bg-red-100 text-red-800"><strong>Total Denda:</strong> <span id="sanksi-result-denda"></span></div>
                    <div class="flex space-x-4 mt-4">
                        <button onclick="exportSanksi('xlsx')" class="btn btn-export">Export ke Excel</button>
                        <button onclick="exportSanksi('csv')" class="btn btn-export">Export ke CSV (Sheets)</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Additional Content -->
        <div class="section-card">
            <h2>Dasar Hukum Kepabeanan</h2>
            <ul class="list-disc list-inside space-y-2 text-gray-700">
                <li><strong>Undang-Undang Nomor 17 Tahun 2006</strong> tentang Perubahan atas Undang-Undang Nomor 10 Tahun 1995 tentang Kepabeanan. (Landasan utama hukum kepabeanan di Indonesia).</li>
                <li><strong>Peraturan Menteri Keuangan (PMK) Nomor 144/PMK.04/2022</strong> tentang Nilai Pabean untuk Penghitungan Bea Masuk.</li>
                <li><strong>Peraturan Menteri Keuangan (PMK) Nomor 51/PMK.04/2017</strong> tentang Pengenaan dan Tata Cara Penghitungan Sanksi Administrasi Berupa Denda di Bidang Kepabeanan.</li>
                <li><strong>Peraturan Menteri Keuangan (PMK) Nomor 34/PMK.010/2017</strong> tentang Pemungutan Pajak Penghasilan Pasal 22 Sehubungan Dengan Pembayaran atas Penyerahan Barang dan Kegiatan di Bidang Impor atau Kegiatan Usaha di Bidang Lain.</li>
                 <li><strong>Undang-Undang Nomor 7 Tahun 2021</strong> tentang Harmonisasi Peraturan Perpajakan (UU HPP), yang mengatur tarif PPN menjadi 11%.</li>
            </ul>
        </div>
        
        <div class="section-card">
            <h2>Analisa Komprehensif</h2>
            <div class="space-y-4 text-gray-700">
                <p>Proses impor barang ke Indonesia melibatkan serangkaian perhitungan yang krusial, tidak hanya bagi importir tetapi juga bagi perekonomian nasional. Setiap komponen memiliki peran dan dampak yang spesifik:</p>
                <p><strong>1. Nilai Pabean (CIF):</strong> Ini adalah fondasi dari semua perhitungan. Nilai Pabean merupakan penjumlahan dari `Cost` (harga barang), `Insurance` (asuransi), dan `Freight` (biaya pengangkutan). Akurasi dalam menentukan Nilai Pabean sangat penting karena menjadi dasar utama pengenaan Bea Masuk dan Pajak Dalam Rangka Impor (PDRI). Kesalahan dalam pemberitahuan nilai ini adalah pelanggaran yang paling umum terjadi dan dapat berujung pada sanksi yang signifikan.</p>
                <p><strong>2. Bea Masuk (BM):</strong> Merupakan pungutan negara yang dikenakan terhadap barang impor. Fungsinya ganda: sebagai sumber penerimaan negara dan sebagai instrumen untuk melindungi industri dalam negeri (fungsi proteksi). Tarif Bea Masuk yang berbeda-beda untuk setiap jenis barang mencerminkan kebijakan pemerintah dalam mendorong atau mengendalikan impor komoditas tertentu.</p>
                <p><strong>3. Pajak Dalam Rangka Impor (PDRI):</strong> Terdiri dari PPN dan PPh Pasal 22. PDRI memastikan bahwa barang impor dikenakan perlakuan pajak yang sama dengan barang produksi lokal (prinsip *level playing field*). PPN dikenakan untuk konsumsi, sementara PPh 22 merupakan pembayaran pajak di muka bagi importir yang dapat dikreditkan dalam laporan pajak tahunannya.</p>
                <p><strong>4. Sanksi Administrasi:</strong> Berfungsi sebagai alat penegakan hukum (law enforcement) untuk memastikan kepatuhan. Skema denda berjenjang yang progresif dirancang untuk memberikan efek jera yang sepadan dengan tingkat pelanggaran. Semakin besar persentase kekurangan bayar, semakin tinggi pula denda yang dikenakan, mendorong importir untuk lebih teliti dan jujur dalam pemberitahuannya.</p>
                <p>Secara keseluruhan, sistem ini menciptakan sebuah ekosistem di mana akurasi dan kepatuhan sangat dihargai. Kalkulator ini dirancang untuk membantu para pelaku usaha memahami dinamika tersebut dan membuat perencanaan yang lebih baik dalam kegiatan impor mereka.</p>
            </div>
        </div>


    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let itemCounter = 0;
    const itemsContainer = document.getElementById('items-container');
    const addItemBtn = document.getElementById('add-item-btn');

    function createItemRow() {
        itemCounter++;
        const itemRow = document.createElement('tr');
        itemRow.id = `item-row-${itemCounter}`;
        itemRow.innerHTML = `
            <td class="font-semibold">${itemCounter}</td>
            <td><input type="text" class="input-field number-input item-cost" placeholder="15.000.000"></td>
            <td><input type="number" class="input-field item-bm-tarif" placeholder="7.5"></td>
            <td><button class="btn btn-danger btn-sm remove-item-btn" data-row-id="${itemCounter}">X</button></td>
        `;
        itemsContainer.appendChild(itemRow);
        itemRow.querySelector('.remove-item-btn').addEventListener('click', function() {
            itemRow.remove();
        });
        addNumberFormatting(itemRow.querySelector('.number-input'));
    }
    
    document.querySelectorAll('.number-input').forEach(addNumberFormatting);
    
    createItemRow();
    addItemBtn.addEventListener('click', createItemRow);
});


function addNumberFormatting(inputElement) {
    if (!inputElement) return;
    inputElement.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, '');
        e.target.value = value ? new Intl.NumberFormat('id-ID').format(value) : '';
    });
}

function unformatNumber(formattedValue) {
    if (typeof formattedValue !== 'string') return 0;
    // Handles both "Rp1.234.567" and "1.234.567"
    return formattedValue.replace(/[^0-9,-]/g, '').replace(/,.*$/, '');
}

function formatRupiah(number, includeSymbol = true) {
    if(includeSymbol) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(Math.round(number));
    }
    return new Intl.NumberFormat('id-ID').format(Math.round(number));
}


function getFloatValue(id) {
    const element = document.getElementById(id);
    const value = element.value;
    if (id === 'main-pph-tarif') {
        return parseFloat(value) || 0;
    }
    return parseFloat(unformatNumber(value)) || 0;
}


function getFloatValueFromElement(element) {
    if (!element) return 0;
    if (element.classList.contains('number-input')) {
        return parseFloat(unformatNumber(element.value)) || 0;
    }
    return parseFloat(element.value) || 0;
}

function calculateMain() {
    const pphTarif = getFloatValue('main-pph-tarif'); 
    const shipmentAdditions = getFloatValue('main-insurance') + getFloatValue('main-freight') + getFloatValue('main-royalty') + getFloatValue('main-warranty');
    const totalDiscount = getFloatValue('main-discount');
    const items = document.querySelectorAll('#items-container tr');

    if (items.length === 0) { alert('Mohon tambahkan setidaknya satu barang.'); return; }
    
    let grandTotalCost = 0;
    items.forEach(row => { grandTotalCost += getFloatValueFromElement(row.querySelector('.item-cost')); });

    if (grandTotalCost === 0) { alert('Total Cost barang tidak boleh nol.'); return; }

    const resultsBody = document.getElementById('pib-results-body');
    const resultsFoot = document.getElementById('pib-results-foot');
    resultsBody.innerHTML = '';
    
    let totalBMUnrounded = 0;
    let total = { np: 0, ni: 0, ppn: 0, pph: 0 };

    items.forEach((row, index) => {
        const serial = index + 1;
        const itemCost = getFloatValueFromElement(row.querySelector('.item-cost'));
        const itemBMTarif = getFloatValueFromElement(row.querySelector('.item-bm-tarif')) / 100;
        
        const costProportion = itemCost / grandTotalCost;
        const apportionedAdditions = shipmentAdditions * costProportion;
        const apportionedDiscount = totalDiscount * costProportion;
        
        const np = (itemCost + apportionedAdditions) - apportionedDiscount;
        const bmUnrounded = np * itemBMTarif;
        totalBMUnrounded += bmUnrounded;
        
        const bmDisplay = bmUnrounded;
        const ni = np + bmUnrounded;
        const ppn = Math.floor(ni * 0.11);
        const niBasisPph = Math.floor(ni / 1000) * 1000;
        const pph = Math.floor(niBasisPph * pphTarif);

        total.np += np;
        total.ni += ni;
        total.ppn += ppn;
        total.pph += pph;

        const resultRow = document.createElement('tr');
        resultRow.innerHTML = `
            <td>${serial}</td>
            <td class="text-right">${formatRupiah(np)}</td>
            <td class="text-right">${formatRupiah(bmDisplay)}</td>
            <td class="text-right">${formatRupiah(ni)}</td>
            <td class="text-right">${formatRupiah(ppn)}</td>
            <td class="text-right">${formatRupiah(pph)}</td>
        `;
        resultsBody.appendChild(resultRow);
    });
    
    const totalBMRounded = Math.ceil(totalBMUnrounded / 1000) * 1000;

    resultsFoot.innerHTML = `
        <tr>
            <td class="font-bold">TOTAL</td>
            <td class="text-right">${formatRupiah(total.np)}</td>
            <td class="text-right">${formatRupiah(totalBMRounded)}</td>
            <td class="text-right">${formatRupiah(total.ni)}</td>
            <td class="text-right">${formatRupiah(total.ppn)}</td>
            <td class="text-right">${formatRupiah(total.pph)}</td>
        </tr>
    `;
    
    document.getElementById('pib-results-detail').classList.remove('hidden');
    document.getElementById('sanksi-placeholder').classList.add('hidden');
    document.getElementById('sanksi-content').classList.remove('hidden');
    populateSanksiCalculator();
}


function resetMain() {
    ['pib-number', 'main-insurance', 'main-freight', 'main-royalty', 'main-warranty', 'main-discount'].forEach(id => { document.getElementById(id).value = ''; });
    document.getElementById('main-pph-tarif').value = '0.025';
    document.getElementById('items-container').innerHTML = '';
    document.getElementById('add-item-btn').click();
    document.getElementById('pib-results-detail').classList.add('hidden');
    
    document.getElementById('sanksi-content').classList.add('hidden');
    document.getElementById('sanksi-placeholder').classList.remove('hidden');
    document.getElementById('sanksi-result-container').classList.add('hidden');
}

function populateSanksiCalculator() {
    const sanksiItemsContainer = document.getElementById('sanksi-items-container');
    sanksiItemsContainer.innerHTML = '';
    const pibResults = document.querySelectorAll('#pib-results-body tr');

    pibResults.forEach((pibResultRow, index) => {
        const serial = index + 1;
        const npDeklarasi = pibResultRow.cells[1].innerText;
        
        const row = document.createElement('tr');
        row.dataset.serial = serial;
        row.innerHTML = `
            <td>${serial}</td>
            <td class="text-right">${npDeklarasi}</td>
            <td class="sanksi-input-np"><input type="text" class="input-field number-input" placeholder="Masukkan NP Seharusnya"></td>
            <td class="sanksi-input-tarif hidden"><input type="number" class="input-field" placeholder="Masukkan Tarif BM Seharusnya (%)"></td>
        `;
        sanksiItemsContainer.appendChild(row);
        addNumberFormatting(row.querySelector('.number-input'));
    });
    toggleSanksiInput(); 
}

function toggleSanksiInput() {
    const sanksiTable = document.getElementById('sanksi-input-table');
    const header = sanksiTable.querySelector('thead');
    const jenis = document.getElementById('sanksi-jenis-pelanggaran').value;

    if (jenis === 'nilai_pabean') {
        header.innerHTML = `<tr><th>Serial</th><th class="text-right">NP Deklarasi</th><th class="text-right">NP Seharusnya (Rp)</th></tr>`;
        document.querySelectorAll('.sanksi-input-np').forEach(el => el.classList.remove('hidden'));
        document.querySelectorAll('.sanksi-input-tarif').forEach(el => el.classList.add('hidden'));
    } else { 
        header.innerHTML = `<tr><th>Serial</th><th class="text-right">NP Deklarasi</th><th class="text-right">Tarif BM Seharusnya (%)</th></tr>`;
        document.querySelectorAll('.sanksi-input-np').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.sanksi-input-tarif').forEach(el => el.classList.remove('hidden'));
    }
}


function calculateSanksi() {
    const jenisKesalahan = document.getElementById('sanksi-jenis-pelanggaran').value;
    const jenisImportir = document.getElementById('sanksi-jenis-importir').value;
    const sanksiItems = document.querySelectorAll('#sanksi-items-container tr');
    const pibItems = document.querySelectorAll('#items-container tr');
    const totalBMDibayarRounded = parseFloat(unformatNumber(document.querySelector('#pib-results-foot tr').cells[2].innerText));

    let totalBMSeharusnyaUnrounded = 0;

    sanksiItems.forEach((row, index) => {
        const npDeklarasiText = row.cells[1].innerText;
        const npDeklarasi = parseFloat(unformatNumber(npDeklarasiText));
        
        let bmSeharusnya = 0;
        if (jenisKesalahan === 'nilai_pabean') {
            const npSeharusnya = getFloatValueFromElement(row.querySelector('.sanksi-input-np input'));
            const tarifBMDeklarasi = getFloatValueFromElement(pibItems[index].querySelector('.item-bm-tarif')) / 100;
            bmSeharusnya = npSeharusnya * tarifBMDeklarasi;
        } else {
            const tarifBMSeharusnya = getFloatValueFromElement(row.querySelector('.sanksi-input-tarif input')) / 100;
            bmSeharusnya = npDeklarasi * tarifBMSeharusnya;
        }
        totalBMSeharusnyaUnrounded += bmSeharusnya;
    });

    const totalBMSeharusnyaRounded = Math.ceil(totalBMSeharusnyaUnrounded / 1000) * 1000;
    
    if (totalBMSeharusnyaRounded < totalBMDibayarRounded) {
        alert('Total BM Seharusnya tidak boleh lebih kecil dari yang sudah dibayar.');
        return;
    }

    const kekuranganBayar = totalBMSeharusnyaRounded - totalBMDibayarRounded;
    let persentaseKekurangan = 0;
    if (totalBMDibayarRounded > 0) {
        persentaseKekurangan = (kekuranganBayar / totalBMDibayarRounded) * 100;
    } else if (kekuranganBayar > 0) {
        persentaseKekurangan = Infinity;
    }

    let tarifDenda = 0;
    if (jenisImportir === 'umum') {
        if (persentaseKekurangan <= 25) tarifDenda = 100;
        else if (persentaseKekurangan <= 50) tarifDenda = 200;
        else if (persentaseKekurangan <= 75) tarifDenda = 300;
        else if (persentaseKekurangan <= 100) tarifDenda = 400;
        else if (persentaseKekurangan <= 125) tarifDenda = 500;
        else if (persentaseKekurangan <= 150) tarifDenda = 600;
        else if (persentaseKekurangan <= 175) tarifDenda = 700;
        else if (persentaseKekurangan <= 200) tarifDenda = 800;
        else if (persentaseKekurangan <= 225) tarifDenda = 900;
        else tarifDenda = 1000;
    } else { 
        if (persentaseKekurangan <= 20) tarifDenda = 100;
        else if (persentaseKekurangan <= 40) tarifDenda = 200;
        else if (persentaseKekurangan <= 60) tarifDenda = 300;
        else if (persentaseKekurangan <= 80) tarifDenda = 400;
        else tarifDenda = 500;
    }
    
    const denda = kekuranganBayar * (tarifDenda / 100);

    document.getElementById('sanksi-total-bm-dibayar').innerText = formatRupiah(totalBMDibayarRounded);
    document.getElementById('sanksi-total-bm-seharusnya').innerText = formatRupiah(totalBMSeharusnyaRounded);
    document.getElementById('sanksi-result-kurang').innerText = formatRupiah(kekuranganBayar);
    document.getElementById('sanksi-result-persen').innerText = `${persentaseKekurangan.toFixed(2)}%`;
    document.getElementById('sanksi-result-tarif').innerText = `${tarifDenda}%`;
    document.getElementById('sanksi-result-denda').innerText = formatRupiah(denda);
    document.getElementById('sanksi-result-container').classList.remove('hidden');
}

// --- EXPORT FUNCTIONS ---

function exportPIB(type) {
    const pibNumber = document.getElementById('pib-number').value || 'data_pib';
    const table = document.getElementById('pib-results-table');
    const wb = XLSX.utils.table_to_book(table, {sheet: "DetailPIB"});
    
    if (type === 'xlsx') {
        XLSX.writeFile(wb, `${pibNumber}.xlsx`);
    } else if (type === 'csv') {
        const csv = XLSX.utils.sheet_to_csv(wb.Sheets.DetailPIB);
        downloadFile(csv, `${pibNumber}.csv`, 'text/csv');
    }
}

function exportSanksi(type) {
    const pibNumber = document.getElementById('pib-number').value || 'data_pib';
    const filename = `sanksi_${pibNumber}`;
    
    const data = [
        ["Keterangan", "Nilai"],
        ["Total BM Dibayar", unformatNumber(document.getElementById('sanksi-total-bm-dibayar').innerText)],
        ["Total BM Seharusnya", unformatNumber(document.getElementById('sanksi-total-bm-seharusnya').innerText)],
        ["Kekurangan Pembayaran BM", unformatNumber(document.getElementById('sanksi-result-kurang').innerText)],
        ["Persentase Kekurangan (%)", document.getElementById('sanksi-result-persen').innerText.replace('%', '')],
        ["Tarif Denda Berlaku (%)", document.getElementById('sanksi-result-tarif').innerText.replace('%', '')],
        ["Total Denda", unformatNumber(document.getElementById('sanksi-result-denda').innerText)]
    ];

    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "RingkasanSanksi");

    if (type === 'xlsx') {
        XLSX.writeFile(wb, `${filename}.xlsx`);
    } else if (type === 'csv') {
        const csv = XLSX.utils.sheet_to_csv(ws);
        downloadFile(csv, `${filename}.csv`, 'text/csv');
    }
}

function downloadFile(content, fileName, mimeType) {
    const a = document.createElement('a');
    const blob = new Blob([content], { type: mimeType });
    a.href= URL.createObjectURL(blob);
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

</script>
</body>
</html>
